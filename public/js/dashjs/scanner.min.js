let html5QrCode=null,isScanning=!1,isFlashOn=!1,currentZoom=1,zoomSlider=document.getElementById("zoomSlider"),zoomValue=document.getElementById("zoomValue");async function startScanner(){try{html5QrCode=new Html5Qrcode("reader");const config={fps:10,qrbox:{width:250,height:250},aspectRatio:1,focusMode:"continuous",showTorchButtonIfSupported:!0};await html5QrCode.start({facingMode:"environment"},config,onScanSuccess),isScanning=!0,initFlashControl(),initZoomControl()}catch(err){console.error("Gagal memulai kamera:",err),showToast("Tidak dapat mengakses kamera. Pastikan izin kamera telah diberikan!","error")}}function initZoomControl(){const videoElement=document.querySelector("#reader video");if(!videoElement)return;const track=videoElement.srcObject.getVideoTracks()[0];if(!track)return;const capabilities=track.getCapabilities(),settings=track.getSettings();!capabilities.zoom||capabilities.zoom.max<1.1?document.getElementById("zoomSlider").style.display="none":(zoomSlider.min=capabilities.zoom.min,zoomSlider.max=capabilities.zoom.max,zoomSlider.step=capabilities.zoom.step,currentZoom=settings.zoom||1,zoomSlider.value=currentZoom,zoomValue.textContent=`${Math.round(100*currentZoom)}%`,zoomSlider.style.display="block",zoomSlider.addEventListener("input",applyZoom))}async function applyZoom(){const videoElement=document.querySelector("#reader video");if(!videoElement||!videoElement.srcObject)return;const track=videoElement.srcObject.getVideoTracks()[0];if(track&&track.applyConstraints)try{currentZoom=parseFloat(zoomSlider.value),await track.applyConstraints({advanced:[{zoom:currentZoom}]}),zoomValue.textContent=`${Math.round(100*currentZoom)}%`}catch(err){console.error("Gagal mengatur zoom:",err),showToast("Gagal mengatur zoom","error")}}function resetScannerState(){isScanning=!1,isFlashOn=!1;const flashBtn=document.getElementById("toggleFlashBtn");flashBtn.style.display="none",zoomSlider.style.display="none",zoomValue.textContent="100%",currentZoom=1;const flashIcon=document.querySelector("#toggleFlashBtn i");flashIcon.classList.remove("bi-lightbulb-fill"),flashIcon.classList.add("bi-lightbulb")}function stopScanner(){html5QrCode&&isScanning&&html5QrCode.stop().then(()=>{isScanning=!1,resetScannerState()}).catch(console.error),resetScannerState()}function initFlashControl(){const flashBtn=document.getElementById("toggleFlashBtn");try{const settings=html5QrCode.getRunningTrackSettings();"torch"in settings?(flashBtn.style.display="inline-block",flashBtn.disabled=!1,updateFlashUI()):flashBtn.style.display="none"}catch(error){console.error("Error checking torch capability:",error),flashBtn.style.display="none"}}async function toggleFlash(){if(html5QrCode&&isScanning)try{isFlashOn=!isFlashOn;const constraints={torch:isFlashOn,advanced:[{torch:isFlashOn}]};await html5QrCode.applyVideoConstraints(constraints);const settings=html5QrCode.getRunningTrackSettings();if(settings.torch!==isFlashOn)throw new Error("Gagal mengubah status flash");updateFlashUI()}catch(err){console.error("Gagal mengubah flash:",err),showToast("Perangkat tidak mendukung flash","error"),isFlashOn=!isFlashOn}}function updateFlashUI(){const flashIcon=document.querySelector("#toggleFlashBtn i");flashIcon.classList.toggle("bi-lightbulb",!isFlashOn),flashIcon.classList.toggle("bi-lightbulb-fill",isFlashOn)}function resetScannerState(){html5QrCode&&isScanning&&html5QrCode.applyVideoConstraints({torch:!1}).catch(console.error),isScanning=!1,isFlashOn=!1;const flashBtn=document.getElementById("toggleFlashBtn");flashBtn.style.display="none";const flashIcon=document.querySelector("#toggleFlashBtn i");flashIcon.classList.remove("bi-lightbulb-fill"),flashIcon.classList.add("bi-lightbulb")}function isValidURL(url){const pattern=/^(https?:\/\/)?([\w.-]+)\.([a-z]{2,})(\/\S*)?$/i;return pattern.test(url)}function onScanSuccess(decodedText){if(stopScanner(),!isValidURL(decodedText))return showToast("URL tidak valid!","error"),document.getElementById("result").textContent="URL tidak valid!",void setTimeout(startScanner,1e3);document.getElementById("result").textContent=decodedText,fetch("/qrcode/scan",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({url:decodedText})}).then(handleResponse).then(data=>{data.success&&(showToast("Berhasil menyimpan link","success"),setTimeout(()=>{bootstrap.Modal.getInstance(document.getElementById("scanQRModal")).hide(),setTimeout(()=>{location.reload()},1e3)},1500))}).catch(handleError)}function handleResponse(response){return response.ok?response.json():response.json().then(err=>Promise.reject(err))}function handleError(error){showToast(error.message||"Terjadi kesalahan","error"),console.error("Error:",error)}function showToast(message,type="success"){Swal.fire({text:message,icon:type,toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0})}document.getElementById("scanQRBtn").addEventListener("click",()=>{new bootstrap.Modal(document.getElementById("scanQRModal")).show()}),document.getElementById("scanQRModal").addEventListener("shown.bs.modal",startScanner),document.getElementById("scanQRModal").addEventListener("hidden.bs.modal",stopScanner),document.getElementById("toggleFlashBtn").addEventListener("click",toggleFlash);